# BottomTime Service
This repository is home to the Bottom Time application backend API service.

![](https://media.giphy.com/media/YtOzpQAehGOdi/giphy.gif)

#### Build Status
Component | Status
--- | ---
Dev Build | [![CircleCI](https://circleci.com/gh/ChrisCarleton/BottomTime-Core/tree/master.svg?style=svg&circle-token=b4c86baca538392eeb5676fd14ef920f2cc44857)](https://circleci.com/gh/ChrisCarleton/BottomTime-Core/tree/master)
Production Build | [![CircleCI](https://circleci.com/gh/ChrisCarleton/BottomTime-Core/tree/prod.svg?style=svg&circle-token=b4c86baca538392eeb5676fd14ef920f2cc44857)](https://circleci.com/gh/ChrisCarleton/BottomTime-Core/tree/prod)
Test Coverage | [![Coverage Status](https://coveralls.io/repos/github/ChrisCarleton/BottomTime-Core/badge.svg?branch=master)](https://coveralls.io/github/ChrisCarleton/BottomTime-Core?branch=master)
Dependencies | [![Dependencies](https://status.david-dm.org/gh/ChrisCarleton/BottomTime-Core.svg)](https://david-dm.org/ChrisCarleton/BottomTime-Core)
Dev Dependencies | [![devDependencies Status](https://status.david-dm.org/gh/ChrisCarleton/BottomTime-Core.svg?type=dev)](https://david-dm.org/ChrisCarleton/BottomTime-Core?type=dev)
Security Vulnerabilities | [![Known Vulnerabilities](https://snyk.io/test/github/ChrisCarleton/BottomTime-Core/badge.svg?targetFile=package.json)](https://snyk.io/test/github/ChrisCarleton/BottomTime-Core?targetFile=package.json)

## Environment Variables
The application is configured through the use of environment variables. Any of these can be set to change
the behaviour of the running application:

* **BT_ES_ENDPOINT** Sets the connection string used to connect to ElasticSearch. The default is
`http://localhost:9200`.
* **BT_ES_INDEX** Sets the prefix for the ElasticSearch indices in which documents are stored. The default
is `bottomtime_dev`.
* **BT_FRIEND_LIMIT** Sets the maximum number of friends users are limitted to. The default is 1000.
* **BT_LOG_FILE** Setting this to a file name will force the application to write its logs to the file
rather than `stdout`.
* **BT_LOG_LEVEL** Sets the level of verbosity of the log output. Valid values are `trace`, `debug`,
`info`, `warn`, `error`, and `fatal`. The default is `debug`.
* **BT_MAX_IMAGE_FILE_SIZE** Sets the maximum file size for images uploaded to the application in bytes.
Default is `10485760` (10Mb.)
* **BT_MEDIA_BUCKET** The name of the S3 bucket where dive media (videos and pictures) are stored for
users.
* **BT_MONGO_ENDPOINT** Sets the connection string for the MongoDB database. The default is
`mongodb://localhost/dev`.
* **BT_PORT** Can be set to override the default port the application listens for requests on. The default
is `29201`.
* **BT_S3_ENDPOINT** Can be set to override the default endpoint used to reach the AWS S3 APIs. (E.g.
`http://localhost:4569/`)
* **BT_SESSION_SECRET** Sets the secret used to encrypt/decrypt session cookies. This doesn't really matter
for testing but should definitely be set to a secure value in production to prevent session hijacking.
* **BT_SITE_URL** Tells the application the base URL of the site. E.g. `https://www.bottomtime.ca/`. This
is important for some components of the application that need to return or provide absolute URLs.
* **BT_SMTP_HOST** The hostname of the SMTP server used for sending out e-mails. Default is `localhost`.
* **BT_SMTP_PASSWORD** The password used to authenticate with the SMTP server.
* **BT_SMTP_PORT** The port number on which the SMTP server should be contacted. The default is `15025`.
* **BT_SMTP_USE_TLS** Whether or not to use TLS (secure connection) when connecting to the SMTP server.
Must be `true` or `false`. Default is `false`.
* **BT_SMTP_USERNAME** The username used to authenticate with the SMTP server.
* **BT_SUPPORT_EMAIL** An e-mail address that users of the site can send e-mails to for support. This will
typically be sent out in emails generated by the service.
* **BT_TEMP_DIR** The absolute path to the directory where the application can create temp files.
(Defaults to `${__dirname}/../temp`.)

### Configuration
Any of the above environment variables can be set in your terminal to change the application's configuration. In addition,
the application uses [dotenv](https://www.npmjs.com/package/dotenv) to load environment variables at runtime. Simply
create a file in the project's root directory called `.env` and configure your desired environment variables there.

When the test suite is run (`yarn test`) environment variables will be loaded from `.env.test` if it exists.

**Warning:** DO NOT check your `.env` or `.env.*` files into source control! These
files should be unique to the environment in which the application is running and
could potentially contain some sensitive configuration information. For
convenience, these files have been added to the `.gitignore` file to avoid
accidental check ins.

## API Documentation
See the full API documentation [here](docs/API.md)!

## Local Development
Here is a guide to get set up to do local development on this repository.

### Development Dependencies
You'll need the following installed:

* **[Node.js](https://nodejs.org/en/download/)** (version 10.15.3 or higher.)
* **[Docker](https://www.docker.com/)** which you will likely need to run local databases.
* **[Yarn](https://yarnpkg.com/)** which can be installed via npm: `npm install -g yarn`.

The source code for the service itself lives in the `service/` directory and the unit/integration tests live
in the `tests/` directory.

### External Dependencies
The application depends on some external, third-party services. Specifically,
* **[MongoDB](https://www.mongodb.com/)** for data persistence
* **[ElasticSearch](https://www.elastic.co/elasticsearch/)** for search indexing
* **[AWS S3](https://aws.amazon.com/s3/)** for storing uploaded files
* An SMTP server for sending e-mails

The easiest way to set these up is to run the `admin/init-local.sh` Bash script from
your terminal. This will launch all four dependencies as Docker files. Additionally,
the databases will be intialized for you.

If you prefer not to use ephemeral Docker containers, or you'd rather host these
services elsewhere so as not to murder your laptop with all of these services
running concurrently, then feel free to set these services up yourself and host
them wherever you please. You can point the application to your external services by
configuring the end points via their corresponding environment variables. (Hint:
save those values in `.env` so you don't need to set them every time you reload
your terminal.) Once you have your end points set up and configured run
`yarn init-local` to initialize the databases. Then you're ready to go!

### Common Development Commands
A number of commands exist for accomplishing various common dev tasks:
* `yarn start` runs the server. It will respond on port `29201` and log output
will be written to `stdout` by default.
* `yarn lint` lints the code files for code smells using ESLint.
* `yarn test` runs the test suite using Mocha.
* `yarn serve` runs a dev server. It works just like `yarn start` except the
server will be run by `nodemon` and will be automatically restarted if a file is
changed in the `service/` directory.

*Hint:* Piping the server's log output through Bunyan makes it much easier to read:
`yarn serve | npx bunyan`

## Deployment
Deployment and continuous integration builds are handled by
[CircleCI](https://circleci.com/gh/ChrisCarleton/BottomTime-Core). Merges to the `master` branch
are deployed to the development environment and merges to `prod` are deployed to the production environment.

The code is first linted/tested and then packaged in a Docker container which is pushed to AWS ECR. Finally,
Terraform is used to spin up an AWS ECS-powered environment to host the application.

* How the Docker image is built is controlled by the `Dockerfile` file in the project root directory.
* Terraform modules can be found at `terraform/modules/` and configuration for specific environments can be
found in `terraform/env/`.
* The CircleCI deployment pipeline is controlled by editing `.circleci/config.yml`.

## Lambda Functions
Currently, the application does have one Node.JS component that is meant to run as an AWS Lambda function.
The task can be found at `lambda/db-maintenance/`. The task is responsible for purging old expired records
from the database. (Specifically, it will delete expired user sessions and friend requests that have been
rejected.) It will be run on a scheduled event triggered by AWS CloudWatch.

There is a test suite to exercise the function. The tests can be found at `tests/lambdas.tests.js`.

The function takes a few environment variables to do its job:
* **BT_MONGO_ENDPOINT** Same as documented above. It's the connection string needed to access the MongoDB
database. The default is `mongodb://localhost/dev`.
* **BT_FRIEND_REQUEST_EXPIRATION_PERIOD** Number of hours a rejected friend request should be kept around
for before being expired and deleted. The default is 240 hours.

## Administrative Tasks
A number of one-off administrative tasks have been created as runnable scripts in `package.json`. These
are largely for working with the database to set up initial data in a new environment.

By default, the scripts will run against `mongodb://localhost/dev`. To change this default, set the
`BT_MONGO_ENDPOINT` environment variable to the desired MongoDB connection string before running these
commands.

### Creating an Administrator User
A new environment will not have any data defined in the database - and that means no administrator accounts
for setting things up! To create an initial Admin account run the following command:

```
yarn create-admin-user
```

You'll be prompted for a strong password. Once completed, the command will have created (or updated) a
privileged user called `Admin` with the password you provided. The command can also be used to reset the
admin password if it is forgotten.

### Generating Test Data
This is meant for test and dev environments where it's useful to have a database populated with plenty of
realistic-ish data. Run

```
yarn generate-test-data
```

This will create several users with plenty of dives logged. The generated usernames will be output to
the terminal and saved to a file called `.test-users.json` for reference. Any of these user accounts can
be logged into using the password `bottomtime`.

Obviously, **do not** run this against the prod database. (Duh!)

### Invalidating User Sessions
Occasionally, it may be necessary to forcefully terminate a user's sessions. Running this command will
invalidate all auth tokens associated with the indicated username. If `.` is supplied in place of a username
then **ALL** sessions will be terminated.

```
yarn kill-sessions (username|.)
```

### Purging the Database
This command will purge **all** data from the datase. All tables will be emptied.

```
yarn purge-database
```

Use with extreme caution. **Do not** run this in production!!!!
